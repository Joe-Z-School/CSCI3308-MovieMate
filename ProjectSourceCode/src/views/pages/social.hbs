
<script src="../resources/js/socialScript.js"></script>
{{> nav}}
<div class="container mt-4">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <div class="row justify-content-between">
        <div class="col-4">
            <h1>Friends Posts</h1>
        </div>
        <div class="col-4 text-end">
            <a class="btn-social" href="/findfriends">Find Friends</a>
        </div>
    </div>
    <div id="movie-container" class="row">
        {{#each posts}}
        <div class="row row-cols-1 row-cols-md-1 g-4">
            <div class="card h-100">
                <p class="card-text">~USER~ {{user}}</p>
                <img src="{{cover}}" class="card-img-top" alt="{{title}}">
                <div class="card-body">
                    <h5 class="card-title text-center">Movie Title: {{title}}</h5>
                    <p class="card-text">Review: {{review}}</p>
                    <p class="card-text">Description: {{description}}</p>
                    <p class="card-text">Where To Watch: {{whereToWatch}}</p>
                    <!--<i class="bi {{#if liked}}bi-heart-fill{{else}}bi-heart{{/if}}"></i> -->
                    <button class="btn heart-button" data-post-id="{{id}}" data-bs-toggle="tooltip"
                        data-bs-title="Like Post">
                        <i class="bi bi-heart"></i>
                    </button>
                    <button class="btn add-button" id="add-button-{{@index}}" data-title="{{title}}"
                        data-cover="{{cover}}" data-where="{{whereToWatch}}" data-bs-toggle="tooltip"
                        data-bs-title="Add to WatchList">
                        <i class="bi bi-plus-circle" id="add-icon-{{@index}}"></i>
                    </button>
                </div>
                <form class="comment-form mt-2" data-post-id="{{id}}">
                    <input type="text" class="form-control comment-input" placeholder="Add a comment..." required>
                    <button type="submit" class="btn btn-sm btn-primary mt-1">Comment</button>
                </form>
            </div>
            
        </div>
        
        {{/each}}
        

    </div>
    <br>
    <div id="loading" class="text-center mt-4" style="display: none;">
        <p>Loading more posts...</p>
    </div>
    <br>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".heart-button").forEach(button => {
    button.addEventListener("click", async (event) => {
      const postId = button.getAttribute("data-post-id");

      try {
        const res = await fetch(`/api/posts/${postId}/like`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });

        const data = await res.json();

        if (res.ok) {
          const icon = button.querySelector("i");
          if (data.action === "liked") {
            icon.classList.remove("bi-heart");
            icon.classList.add("bi-heart-fill");
            console.log("Post liked");
          } else if (data.action === "unliked") {
            icon.classList.remove("bi-heart-fill");
            icon.classList.add("bi-heart");
            console.log("Post unliked");
          }
        } else {
          console.error("Failed to like/unlike post.");
        }
      } catch (err) {
        console.error("Error toggling like:", err);
      }
    });
  });

  //Allowing comments to be made on the posts
  document.querySelectorAll(".comment-form").forEach(form => {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const postId = form.getAttribute("data-post-id");
    const input = form.querySelector(".comment-input");
    const comment = input.value.trim();

    if (!comment) return;

    try {
      const res = await fetch(`/api/posts/${postId}/comment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ comment })
      });

      if (res.ok) {
        input.value = ""; // Clear input
        console.log("Comment added");
        // Optionally append new comment to DOM
      } else {
        console.error("Failed to comment");
      }
    } catch (err) {
      console.error("Comment error:", err);
    }
  });
});

});


</script>